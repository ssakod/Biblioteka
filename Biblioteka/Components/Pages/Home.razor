@page "/"
@using System.IO
@using System.Diagnostics
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>File Explorer</h3>

<div>
    <label>Enter directory path:</label>
    <input @bind="directoryPath" ="C:\Path\To\Directory" />
    <button @onclick="LoadDirectory">Load Directory</button>
</div>

<div style="display: flex; gap: 20px;">
    <div style="flex: 1; max-width: 35vw; height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
        @if (directoryContents != null)
        {
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 400px;">Name</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                    </tr>
                </thead>
                <tbody>
                    <tr @onclick="OnBackClick">
                        <td>../</td>
                    </tr>
                    @foreach (var item in directoryContents)
                    {
                        <tr @onclick="() => OnItemClick(item)">
                            <td style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @item.Name
                            </td>
                            <td>@(item.IsDirectory ? "Directory" : "File")</td>
                            <td>@(item.IsDirectory ? "" : FormatSize(item.Size))</td>
                            <td>@item.LastModified.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
    <div style="flex: 2; max-width: 60vw; height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
        @if (selectedFileContent != null)
        {
            <h4>File Content:</h4>
            <pre>@selectedFileContent</pre>
        }
    </div>
</div>

<div>
    <button @onclick="CreateNewFolder" class="btn btn-secondary">Create New Folder</button>
    <InputFile OnChange="OnFileSelected" />
    <button @onclick="UploadFile" class="btn btn-secondary">Upload File</button>
</div>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>
<p role="status">Current count: @currentCount</p>

@code {
    private int currentCount = 0;
    private string? directoryPath;
    private List<DirectoryItem> directoryContents;
    private string? selectedFileContent;
    private IBrowserFile? selectedFile;

    private async Task IncrementCount()
    {
        currentCount++;
        Trace.WriteLine(3413245134);
        StateHasChanged();
    }

    private async Task LoadDirectory()
    {
        if (Directory.Exists(directoryPath))
        {
            directoryContents = new List<DirectoryItem>();
            foreach (var dir in Directory.GetDirectories(directoryPath))
            {
                var dirInfo = new DirectoryInfo(dir);
                directoryContents.Add(new DirectoryItem
                    {
                        Name = dirInfo.Name,
                        IsDirectory = true,
                        LastModified = dirInfo.LastWriteTime
                    });
            }
            foreach (var file in Directory.GetFiles(directoryPath))
            {
                var fileInfo = new FileInfo(file);
                directoryContents.Add(new DirectoryItem
                    {
                        Name = fileInfo.Name,
                        IsDirectory = false,
                        Size = fileInfo.Length,
                        LastModified = fileInfo.LastWriteTime
                    });
            }
        }
        else
        {
            directoryContents = null;
        }
    }

    private void OnBackClick()
    {
        directoryPath = string.Join(@"\", directoryPath.Split(@"\").SkipLast(1)) + @"/";
        LoadDirectory();
    }

    private void OnItemClick(DirectoryItem item)
    {
        if (item.IsDirectory)
        {
            directoryPath = Path.Combine(directoryPath, item.Name);
            LoadDirectory();
        }
        else
        {
            selectedFileContent = File.ReadAllText(Path.Combine(directoryPath, item.Name));
        }
    }

    private string FormatSize(long size)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        int order = 0;
        while (size >= 1024 && order < sizes.Length - 1)
        {
            order++;
            size /= 1024;
        }
        return $"{size:0.##} {sizes[order]}";
    }

    private async Task CreateNewFolder()
    {
        if (!string.IsNullOrEmpty(directoryPath))
        {
            var newFolderPath = Path.Combine(directoryPath, "NewFolder");
            Directory.CreateDirectory(newFolderPath);
            await LoadDirectory();  // Перезагружаем содержимое директории
        }
    }

    private async Task UploadFile()
    {
        if (selectedFile != null && !string.IsNullOrEmpty(directoryPath))
        {
            var filePath = Path.Combine(directoryPath, selectedFile.Name);
            using (var stream = selectedFile.OpenReadStream())
            using (var fileStream = new FileStream(filePath, FileMode.Create))
            {
                await stream.CopyToAsync(fileStream);
            }
            await LoadDirectory();  // Перезагружаем содержимое директории
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        Console.WriteLine($"File selected: {selectedFile?.Name}");
    }

    private class DirectoryItem
    {
        public string Name { get; set; }
        public bool IsDirectory { get; set; }
        public long Size { get; set; }
        public DateTime LastModified { get; set; }
    }
}
